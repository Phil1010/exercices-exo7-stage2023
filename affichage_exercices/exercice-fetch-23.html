<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Exo23 avec fetch</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Librairie mathjax -->
    <script src="https://polyfill.io/v3/polyfill.js?features=es6"></script>
    
    <!-- Configuration de MathJax -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>

    <!-- Librairie mathjax -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.0.4/es5/tex-mml-chtml.min.js"></script>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>    
  </head>

  <body>
    
    <div id="affichagePage"></div>

    
    <script>
      // Remplace tous les  \'[lettre]  par la lettre avec accent
      function replaceAccents(chaine) {
        const accents = [String.raw`\\'e`, String.raw`\\\`e`, String.raw`\\\^e`, String.raw`\\"e`,
                        String.raw`\\\`a`, String.raw`\\\^a`, String.raw`\\\^i`, String.raw`\\"i`,
                        String.raw`\\\^o`, String.raw`\\"o`, String.raw`\\\^u`, String.raw`\\"u`];

          // Flag 'g' pour remplacer toutes les occurrences.
          const exp_reg0 = new RegExp(accents[0], 'g');
          chaine = chaine.replace(exp_reg0, "é");
          const exp_reg1 = new RegExp(accents[1], 'g');
          chaine = chaine.replace(exp_reg1, "è");
          const exp_reg2 = new RegExp(accents[2], 'g');
          chaine = chaine.replace(exp_reg2, "ê");
          const exp_reg3 = new RegExp(accents[3], 'g');
          chaine = chaine.replace(exp_reg3, "ë");
          const exp_reg4 = new RegExp(accents[4], 'g');
          chaine = chaine.replace(exp_reg4, "à");
          const exp_reg5 = new RegExp(accents[5], 'g');
          chaine = chaine.replace(exp_reg5, "â");
          const exp_reg6 = new RegExp(accents[6], 'g');
          chaine = chaine.replace(exp_reg6, "î");
          const exp_reg7 = new RegExp(accents[7], 'g');
          chaine = chaine.replace(exp_reg7, "ï");
          const exp_reg8 = new RegExp(accents[8], 'g');
          chaine = chaine.replace(exp_reg8, "ô");
          const exp_reg9 = new RegExp(accents[9], 'g');
          chaine = chaine.replace(exp_reg9, "ö");
          const exp_reg10 = new RegExp(accents[10], 'g');
          chaine = chaine.replace(exp_reg10, "û");
          const exp_reg11 = new RegExp(accents[11], 'g');
          chaine = chaine.replace(exp_reg11, "ü");
          return chaine;
      } 


const urlExo23 = 'https://raw.githubusercontent.com/exo7math/exercices-exo7/master/exercices/ex000023.txt';

// Fonction qui ajoute des lignes vides (<br>)
function addNewLines(numLines, containerElement) {
        for (let i = 0; i < numLines; i++) {
          const newLine = document.createElement('br');
          containerElement.appendChild(newLine);
        }
      }

const fetchData = async () => {
    try {
      const response = await fetch(urlExo23);
      if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
      }
      const exo = await response.text();
      console.log(exo); // Access the fetched data
      
      // initialisation des variables
      let html = numExercice = auteur = date = enonce = indication = correction = '';
  
      
      // Mots clés devant figurant dans chaque exercice 
      var motsObligatoires= [String.raw`\exercice`, String.raw`\finexercice`, String.raw`\enonce`,String.raw`\finenonce`];
      // Vérifie si ces mots sont présents dans le texte de l'exercice
      var latexValide= motsObligatoires.every(item => exo.includes(item));

      if (!latexValide){ // Si non présents, exercice incorrect
        document.write("<h2> Le code latex de l'exercice contient une erreur </h2>");
        throw new Error("Code latex incorrect");} // Arret du script
      

      
      //Si l'exercice est correctement écrit :

      // Gestion de bug avec le tag LaTeX : \begin{enumerate}
      var beginEnumerate = exo.indexOf(String.raw`\begin{enumerate}`);
      // Suppression du tag s'il est présent dans l'exercice
      if (beginEnumerate != -1){ 
        exo = exo.replaceAll(String.raw`\begin{enumerate}`, '');
        exo = exo.replaceAll(String.raw`\item`, '');
        exo = exo.replaceAll(String.raw`\end{enumerate}`, '');
      }

      // Récupération de l'entête
      const debutEntete = exo.indexOf("{");
      const finEntete = exo.indexOf("}");

      var entete = exo.slice(debutEntete+1, finEntete);
      entete = entete.split(", ");

      numExercice = entete[0];
      auteur = entete[1];
      date = entete[2];

      // Récupération de vidéo
      const debutVideo = exo.indexOf(String.raw`\video`);
      if (debutVideo != -1){ // S'il y a une vidéo
        video = exo.slice(debutVideo, debutVideo+100);
        var finVideo = video.indexOf("}");
        video = video.slice(7, finVideo);
      }

      // Récupération de l'énoncé
      const debutEnonce = exo.indexOf(String.raw`\enonce`);
      const finEnonce = exo.indexOf(String.raw`\finenonce`);
      enonce = exo.slice(debutEnonce+7, finEnonce);
      
      // Récupération de l'indication s'il y en a
      const debutIndication = exo.indexOf(String.raw`\indication`);
      if (debutIndication != -1){
        const finIndication = exo.indexOf(String.raw`\finindication`);
        indication = exo.slice(debutIndication+12, finIndication);
      }
      
      // Récupération de la correction s'il y en a
      const debutCorrection = exo.indexOf(String.raw`\correction`);
      if (debutCorrection != -1){
        const finCorrection = exo.indexOf(String.raw`\fincorrection`);
        correction = exo.slice(debutCorrection+12, finCorrection-1);
      }

      // Remplacement des accents.
      auteur = replaceAccents(auteur);
      enonce = replaceAccents(enonce);
      indication = replaceAccents(indication);
      correction = replaceAccents(correction);
      correction = correction.replaceAll(String.raw`\qquad`, '&emsp;');
      
      // Get the container element
      const affichagePage = document.getElementById("affichagePage");
      affichagePage.classList.add("container-fluid");

      // Entete
      const affichageExo = document.createElement("h1");
      affichageExo.textContent = 'Exercice ' + numExercice;
      const affichageAuteur = document.createElement("h3");
      affichageAuteur.textContent = 'Auteur : ' + auteur;
      const affichageDate = document.createElement("h4");
      affichageDate.textContent = 'Le : ' + date;      
      
      // Enonce 
      const affichageEnonce = document.createElement("h4");
      affichageEnonce.textContent = 'Enoncé : ';
      const contenuEnonce = document.createElement("p");
      contenuEnonce.textContent = enonce;

      // Indication
      const affichageIndication = document.createElement("h4");
      affichageIndication.textContent = 'Indications : ';
      const contenuIndication = document.createElement("p");
      contenuIndication.textContent = indication;

      // Correction
      const affichageCorrection = document.createElement("h4");
      affichageCorrection.textContent = 'Correction : ';
      const contenuCorrection= document.createElement("p");
      contenuCorrection.textContent = correction;

      
      // Ajout des éléments à la page
      affichagePage.appendChild(affichageExo);
      affichagePage.appendChild(affichageAuteur);
      affichagePage.appendChild(affichageDate);
      addNewLines(2, affichagePage);
      affichagePage.appendChild(affichageEnonce);
      affichagePage.appendChild(contenuEnonce);
      addNewLines(1, affichagePage);
      affichagePage.appendChild(affichageIndication);
      affichagePage.appendChild(contenuIndication);
      addNewLines(1, affichagePage);
      affichagePage.appendChild(affichageCorrection);
      affichagePage.appendChild(contenuCorrection);
    }
    catch (error) {
      console.error(`Fetch error: ${error}`);
    };
  };
  //MathJax.Hub.Typeset(document.getElementById('affichagePage'));
  fetchData();
    </script>
  </body>
</html>